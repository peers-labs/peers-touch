# æ¶ˆæ¯å­˜å‚¨ç³»ç»Ÿï¼ˆåˆç¨¿ï¼‰

## äº‹ä»¶é€šçŸ¥é€šç”¨åŒ–è®¾è®¡

- ç›®æ ‡ï¼šäº‹ä»¶æœºåˆ¶ä¸ä»…æœåŠ¡äºå…³æ³¨å…³ç³»ï¼ˆFollow/Undo/Acceptï¼‰ï¼Œä¹Ÿç»Ÿä¸€æœåŠ¡èŠå¤©æ¶ˆæ¯ï¼ˆChat Messageï¼‰ã€è¯„è®ºï¼ˆCommentï¼‰ã€å†…å®¹äº’åŠ¨ï¼ˆLike/Announce/Deleteï¼‰ã€ç³»ç»Ÿé€šçŸ¥ç­‰ã€‚

- äº‹ä»¶ä¿¡å°ï¼ˆEnvelopeï¼‰ï¼š
  - å­—æ®µï¼š`eventId`ã€`version`ã€`type`ã€`actorId`ã€`targetId`ã€`objectId`ã€`scope`ï¼ˆactor|conv|contentï¼‰ã€`seq`ï¼ˆæ¯-ä¸»ä½“å•è°ƒï¼‰ã€`ts`ã€`payload`ï¼ˆJSONï¼‰
  - ç±»å‹å‘½åï¼š`<åŸŸ>.<åŠ¨ä½œ>`ï¼ˆç¤ºä¾‹ï¼š`follow.requested`ã€`chat.message.appended`ã€`chat.message.read`ã€`comment.created`ã€`like.added`ã€`content.deleted`ï¼‰

- æ¨¡å—èŒè´£ï¼ˆè§£è€¦ï¼‰ï¼š
  - æ´»åŠ¨æ¥æ”¶å™¨ï¼ˆåè®®å±‚ï¼‰ï¼šè§£æå…¥ç«™ Activity æˆ–ä¸šåŠ¡åŠ¨ä½œï¼Œä¸ç›´æ¥é€šçŸ¥
  - é¢†åŸŸæœåŠ¡ï¼ˆå„åŸŸï¼‰ï¼šæ›´æ–°æœ¬åŸŸçŠ¶æ€å¹¶â€œå‘å‡ºé¢†åŸŸäº‹ä»¶â€å¯¹è±¡
  - äº‹ä»¶å‡ºç«™å™¨ï¼ˆTransactional Outboxï¼‰ï¼šå°†é¢†åŸŸäº‹ä»¶ä¸åŸŸæ•°æ®æ›´æ–°åŒäº‹åŠ¡å†™å…¥ Outbox è¡¨ï¼ˆå¹‚ç­‰ `dedupKey`ï¼‰
  - äº‹ä»¶è°ƒåº¦å™¨ï¼ˆDispatcherï¼‰ï¼šå¼‚æ­¥æ‰«æ Outboxï¼Œå‘å¸ƒåˆ°äº‹ä»¶æ€»çº¿ï¼ˆåªå‘å¸ƒ `eventId` æˆ–è½»é‡å¼•ç”¨ï¼‰
  - äº‹ä»¶æ€»çº¿ï¼ˆå¯æ’æ‹”ï¼‰ï¼šmemory+db èµ·æ­¥ï¼Œåç»­å¯æ›¿æ¢ä¸º Postgres LISTEN/NOTIFYã€Redis Streamsã€NATS
  - è®¢é˜…æ³¨å†Œè¡¨ï¼ˆSubscriptionRegistryï¼‰ï¼šç»´æŠ¤åœ¨çº¿è®¢é˜…ï¼ˆactor/conv/contentï¼‰åˆ°è¿æ¥é›†åˆçš„æ˜ å°„
  - æŠ•é€’è·¯ç”±ï¼ˆDeliveryRouterï¼‰ï¼šæŒ‰ `scope` å°†äº‹ä»¶è·¯ç”±åˆ°ç›®æ ‡è®¢é˜…è¿æ¥ï¼Œæ”¯æŒç±»å‹è¿‡æ»¤
  - è¿æ¥æ¢çº½ï¼ˆConnectionHubï¼‰ï¼šSSE/WS ç®¡ç†ã€èƒŒå‹ã€æ–­çº¿ä¸é‡è¿ï¼ˆ`Last-Event-ID`ï¼‰

- è®¢é˜…ä¸æƒé™ï¼š
  - Actor è®¢é˜…ï¼šä»…å…è®¸è®¢é˜…è‡ªèº« actor çš„äº‹ä»¶ï¼ˆç™»å½•æ€æˆ– Tokenï¼‰
  - ä¼šè¯è®¢é˜…ï¼šä»…ä¼šè¯æˆå‘˜å¯è®¢é˜… `conv` äº‹ä»¶ï¼ˆèŠå¤©æ¶ˆæ¯ã€å›æ‰§ï¼‰
  - å†…å®¹è®¢é˜…ï¼šæŒ‰éœ€è¦å¼€æ”¾ï¼ˆå¦‚è¯„è®ºã€ç‚¹èµï¼‰ï¼Œéµå¾ªå¯è§æ€§è§„åˆ™

- è¡¥æ¼ä¸ä¸€è‡´æ€§ï¼š
  - æ‹‰å–æ¥å£ï¼š`GET /events/:scope/pull?since=<eventId>&limit=<N>` æŒ‰ä¸»ä½“æ¸¸æ ‡åˆ†é¡µè¡¥é½
  - é¡ºåºï¼šä»¥ `seq` ä¿è¯æ¯ä¸»ä½“å±€éƒ¨æœ‰åºï¼›å‰ç«¯ä»¥ `eventId` å»é‡

- é€šç”¨äº‹ä»¶ç¤ºä¾‹ï¼š
  - å…³æ³¨åŸŸï¼š`follow.requested`ã€`follow.accepted`ã€`follow.rejected`ã€`follow.undone`
  - èŠå¤©åŸŸï¼š`chat.message.appended`ï¼ˆpayload å« `convId/msgId`ï¼‰ã€`chat.message.delivered`ã€`chat.message.read`
  - è¯„è®ºåŸŸï¼š`comment.created`ã€`comment.deleted`ã€`comment.updated`
  - äº’åŠ¨åŸŸï¼š`like.added`ã€`announce.shared`ã€`undo.like`
  - ç³»ç»ŸåŸŸï¼š`system.alert`ã€`node.status.changed`

- åˆå§‹å®ç°ï¼ˆmemory+dbï¼‰ï¼š
  - Outboxï¼šç»Ÿä¸€è¡¨ç»“æ„ä½œä¸ºæƒå¨æ¥æºï¼›ä¸åŸŸæ›´æ–°åŒäº‹åŠ¡æäº¤
  - æ€»çº¿ï¼šæœ¬èŠ‚ç‚¹å†…å­˜å‘å¸ƒ-è®¢é˜…ï¼Œè·¨èŠ‚ç‚¹ä¾èµ– DB è½®è¯¢ï¼ˆåç»­å¯æ›¿æ¢ï¼‰
  - å‰ç«¯ï¼šSSE/WS å•è¿æ¥ï¼›äº‹ä»¶æ€»çº¿ç»Ÿä¸€è½¬ä¸ºçŠ¶æ€æœºäº‹ä»¶ï¼Œé©±åŠ¨ UIï¼ˆå…³ç³»ä¸ä¼šè¯ç­‰ï¼‰

## é˜Ÿåˆ—è¾¹ç•Œä¸çŠ¶æ€æœºï¼ˆè¿›æ ˆ/å‡ºæ ˆ/å›æ»šï¼‰

- äº‹ä»¶çŠ¶æ€æœºï¼š
  - `PENDING`ï¼šå†™å…¥ Outbox æˆåŠŸï¼Œç­‰å¾…è°ƒåº¦
  - `QUEUE_SKIPPED`ï¼šä¸æ»¡è¶³å…¥æ ˆæ¡ä»¶ï¼ˆç›®æ ‡ä¸åœ¨çº¿/æ— è®¢é˜…/èƒŒå‹ï¼‰ï¼Œä»…ç•™åº“
  - `ENQUEUED`ï¼šè¿›å…¥æœ¬èŠ‚ç‚¹å†…å­˜é˜Ÿåˆ—ï¼Œç­‰å¾…æ´¾å‘
  - `IN_FLIGHT`ï¼šå·²å‘é€åˆ°è¿æ¥ï¼Œç­‰å¾… ACKï¼ˆæˆ–è§†ä¸ºäº¤ä»˜å®Œæˆï¼Œå–å†³äºé€šé“ç±»å‹ï¼‰
  - `ACKED`ï¼šå®¢æˆ·ç«¯ç¡®è®¤æ”¶åˆ°ï¼ˆæˆ–é€šé“å¯é äº¤ä»˜ï¼‰
  - `TIMEOUT`ï¼šåœ¨ ACK æˆªæ­¢æ—¶é—´æœªç¡®è®¤ï¼Œè¿›å…¥å›æ»šï¼ˆé‡è¯•ï¼‰
  - `RETRY`ï¼šé‡æ–°è¿›å…¥è°ƒåº¦ï¼ˆæŒ‡æ•°é€€é¿ï¼Œ`attempts+1`ï¼‰
  - `DEAD_LETTER`ï¼šè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œç­‰å¾…äººå·¥æˆ–ç¦»çº¿è¡¥æ‹‰

- å…¥æ ˆï¼ˆè¿›å†…å­˜é˜Ÿåˆ—ï¼‰çš„â€œæ ˆ Wrapperâ€åˆ¤æ–­ï¼š
  - æ¡ä»¶å‡½æ•° `shouldQueue(evt, target)`ï¼š
    - ç›®æ ‡æ˜¯å¦åœ¨çº¿ï¼ˆSubscriptionRegistry æœ‰è¿æ¥ï¼‰
    - ç›®æ ‡æ˜¯å¦è®¢é˜…è¯¥ `scope/type`
    - é˜Ÿåˆ—è´Ÿè½½æ˜¯å¦å¯æ¥å—ï¼ˆèƒŒå‹é˜ˆå€¼ï¼‰
  - æ»¡è¶³æ¡ä»¶ â†’ æ ‡è®° `ENQUEUED`ï¼Œæ”¾å…¥é˜Ÿåˆ—ï¼›å¦åˆ™æ ‡è®° `QUEUE_SKIPPED`ï¼Œä»…ç•™åº“ï¼Œç­‰å¾…åç»­æœºä¼šï¼ˆä¸Šçº¿/è®¢é˜…å˜åŒ–/å®šæ—¶åˆ·æ–°ï¼‰

- å‡ºæ ˆï¼ˆæ´¾å‘åˆ°è¿æ¥ï¼‰ï¼š
  - å‘é€åæ ‡è®° `IN_FLIGHT`ï¼Œè®¾ç½® `ack_deadline = now + T`
  - ACK æœºåˆ¶ï¼š
    - SSE/WS éäº‹åŠ¡ä¿¡é“éœ€æ˜¾å¼ ACKï¼š`POST /events/:actor/ack` æˆ–æ‰¹é‡ `POST /events/:actor/acks`ï¼ˆæºå¸¦ `eventId[]`ï¼‰
    - è‹¥é‡‡ç”¨å¯é æ¶ˆæ¯é€šé“ï¼ˆåç»­å¯é€‰ï¼‰ï¼Œå¯å°†äº¤ä»˜å³è§†ä¸º ACK
  - æ”¶åˆ° ACK â†’ æ ‡è®° `ACKED`ï¼Œä»é˜Ÿåˆ—ç§»é™¤ï¼›æœªæ”¶åˆ° â†’ è¶…æ—¶æµç¨‹

- è¶…æ—¶ä¸å›æ»šï¼š
  - è¶…æ—¶æœª ACK â†’ æ ‡è®° `TIMEOUT`ï¼Œå†™ `attempts+1` å¹¶è½¬ `RETRY`
  - é€€é¿ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ï¼ˆå¦‚ 1s, 2s, 4s, ... ä¸Šé™ï¼‰ï¼Œæˆ–å›ºå®šçª—å£é‡è¯•
  - è¶…è¿‡é‡è¯•ä¸Šé™ â†’ `DEAD_LETTER`ï¼Œä¿æŒåœ¨åº“ä¸­ä¾›å‰ç«¯è¡¥æ‹‰æˆ–åå°ä¿®å¤

- ä¸Šçº¿ä¸è®¢é˜…å˜åŒ–ï¼š
  - å½“ç›®æ ‡ actor ä¸Šçº¿æˆ–æ–°å¢è®¢é˜…ï¼Œè§¦å‘è°ƒåº¦å™¨æ‰«æè¯¥ä¸»ä½“çš„ `PENDING/QUEUE_SKIPPED/RETRY` äº‹ä»¶ï¼Œé‡æ–°è¯„ä¼°å…¥æ ˆæ¡ä»¶å¹¶æ¨è¿›æ´¾å‘

- ç¦»çº¿åœºæ™¯ç¤ºä¾‹ï¼ˆå…³æ³¨ï¼‰ï¼š
  - æˆ‘å…³æ³¨ä½ ï¼Œä½†ä½ ä¸åœ¨çº¿ â†’ äº‹ä»¶å†™åº“ `PENDING` â†’ Wrapper åˆ¤å®šä¸å…¥æ ˆï¼Œå˜ä¸º `QUEUE_SKIPPED`
  - ä½ ä¸Šçº¿ â†’ è°ƒåº¦å™¨é‡è¯„ä¼°ï¼Œå°†äº‹ä»¶æ¨è¿› `ENQUEUED` â†’ `IN_FLIGHT` â†’ ACK æˆ–é‡è¯•

- é•¿æœŸæœªåœ¨çº¿ä¸è¡¥æ‹‰ï¼š
  - å®¢æˆ·ç«¯é‡è¿å¹¶æºå¸¦ `Last-Event-ID` â†’ æœåŠ¡ç«¯é€šè¿‡ `pull(since)` è¿”å›æœªé€è¾¾æˆ–æ­»ä¿¡ä¸­çš„äº‹ä»¶ï¼ˆå« `QUEUE_SKIPPED/RETRY/DEAD_LETTER`ï¼‰
  - å®¢æˆ·ç«¯æŒ‰ `eventId` å»é‡ï¼ŒçŠ¶æ€æœºåº”ç”¨ä¸ UI ä¿®å¤

- å¹‚ç­‰ä¸å»é‡ï¼š
  - `dedupKey = activityId + type` é˜²æ­¢é¢†åŸŸå±‚é‡å¤äº§ç”Ÿäº‹ä»¶
  - æŠ•é€’ç«¯ä»¥ `eventId` å»é‡ï¼Œç¡®ä¿â€œè‡³å°‘ä¸€æ¬¡â€äº¤ä»˜ä¸å¯¼è‡´çŠ¶æ€é”™ä¹±

- èƒŒå‹ä¸èµ„æºä¿æŠ¤ï¼š
  - æ¯è¿æ¥é˜Ÿåˆ—é•¿åº¦ä¸é€Ÿç‡é™åˆ¶ï¼›è¶…é™ç›´æ¥æ–­å¼€æˆ–åˆ‡æ¢ä¸ºè½®è¯¢è¡¥æ‹‰æ¨¡å¼
  - å…¨å±€é™æµä¿æŠ¤ï¼ˆäº‹ä»¶äº§ç”Ÿç‡ä¸æ´¾å‘ç‡ï¼‰ï¼Œé¿å…é˜»å¡æ ¸å¿ƒé“¾è·¯

## Broker æ’ä»¶åŒ–ä¸å‘½åé€‰æ‹©

- æ’ä»¶ä½ç½®ï¼š`station/frame/core/plugin/broker/{a|b|c}`
  - åœ¨ `broker/a`ã€`broker/b`ã€`broker/c` ä¸‹æä¾›ç¬¬ä¸€ç‰ˆé»˜è®¤å®ç°ï¼ˆä¾‹å¦‚ memory/db/kafka çš„å ä½å®ç°ï¼‰ï¼Œç»Ÿä¸€å®ç° `Broker` æ¥å£ã€‚
  - `native` å±‚æŒ‰åç§°å¼•ç”¨ `a|b|c` å³å¯å®Œæˆæ³¨å…¥ä¸ä½¿ç”¨ã€‚

- å¤š Broker æ”¯æŒï¼ˆæŒ‰ name é€‰æ‹©ï¼‰ï¼š
  - åŒä¸€æœåŠ¡å¯æ³¨å†Œå¤šä¸ª Broker å®ä¾‹ï¼Œé€šè¿‡ `name` è¿›è¡ŒåŒ¹é…ä¸æ³¨å…¥ã€‚
  - ç¤ºä¾‹é…ç½®ï¼ˆä¼ªç¤ºæ„ï¼‰ï¼š
    ```yaml
    broker:
      - name: a
        kind: a
        dsn: postgres://...
      - name: b
        kind: b
      - name: c
        kind: c
        endpoints: ["kafka-1:9092","kafka-2:9092"]
    ```
  - ä¸šåŠ¡æ¨¡å—æŒ‰éœ€å£°æ˜æ‰€éœ€çš„ `brokerName`ï¼Œç”±æ’ä»¶å®¹å™¨åœ¨åˆå§‹åŒ–æœŸæ³¨å…¥å¯¹åº”å®ä¾‹ï¼š
    ```go
    func UseBroker(brokerName string) (Broker, error)
    ```

- ä½¿ç”¨è§„èŒƒï¼š
  - æ ¹æ®åŸŸé€‰æ‹© broker åç§°ï¼šå¦‚å…³ç³»/äº‹ä»¶æ´¾å‘ç”¨ `a`ï¼ŒèŠå¤©/ä¼šè¯ç”¨ `b`ï¼Œåˆ†æé“¾è·¯ç”¨ `c`ã€‚
  - è®¢é˜…ç«¯æŒ‡å®š `group` ä¸è¿‡æ»¤å™¨ï¼Œç¡®ä¿å¤šå‰¯æœ¬ä¸å¤šç§Ÿä½¿ç”¨ã€‚

- ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š
  - æ’ä»¶å®¹å™¨è´Ÿè´£åˆ›å»º/å¯åŠ¨/å…³é—­ Brokerï¼›è¿›ç¨‹é€€å‡ºæ—¶ç»Ÿä¸€è°ƒç”¨ `Close()`ã€‚
  - çƒ­æ›´æ–°ç­–ç•¥ï¼šå¯æ”¯æŒæŒ‰ name é‡è½½å®ç°ï¼ˆé«˜çº§ç‰¹æ€§ï¼Œåç»­è®¾è®¡ï¼‰ã€‚




## ç›®æ ‡ä¸èŒƒå›´

- æ”¯æŒä¸¤ç±»ä¼šè¯ï¼šç”¨æˆ·ä¸ç”¨æˆ·èŠå¤©ã€ç”¨æˆ·ä¸ AI èŠå¤©ã€‚
- é¢å‘å»ä¸­å¿ƒåŒ–èŠ‚ç‚¹ï¼ˆP2P/Federationï¼‰è®¾è®¡ï¼Œä¿éšœç¦»çº¿å¯ç”¨ã€æ–­ç‚¹ç»­ä¼ ã€æœ€ç»ˆä¸€è‡´ã€‚
- è¦†ç›–ä¸°å¯Œæ¶ˆæ¯ç±»å‹ï¼Œä¸ä»…æ–‡æœ¬ï¼Œè¿˜åŒ…å«å¤šåª’ä½“ã€ç»“æ„åŒ–ä¸ç³»ç»Ÿäº‹ä»¶ã€‚
- å…¼é¡¾ä¸åŒè§„æ¨¡çš„ä¸Šå±‚æœåŠ¡ï¼šå°å‹å•èŠ‚ç‚¹ã€ä¸­å‹è½»é‡æœåŠ¡ã€å¤§å‹è”é‚¦ä¸ä¸“ç”¨æœåŠ¡é›†ç¾¤ã€‚

## è®¾è®¡åŸåˆ™

- ç«¯åˆ°ç«¯åŠ å¯†ä¸æœ€å°å¯è§å…ƒæ•°æ®ï¼Œä¿æŠ¤éšç§ä¸æŠ—å®¡æŸ¥ã€‚
- è¿½åŠ å¼äº‹ä»¶æ—¥å¿—ä¸å¯æº¯æºå†…å®¹å¯»å€ï¼Œä¾¿äºåŒæ­¥ä¸å»é‡ã€‚
- å¯ç»„åˆçš„æ•°æ®æ¨¡å‹ï¼šæ¶ˆæ¯ä¸»ä½“ä¸é™„ä»¶åˆ†ç¦»ï¼Œç´¢å¼•ä¸å‰¯æœ¬ç‹¬ç«‹ã€‚
- é€çº§æ‰©å±•ï¼šèŠ‚ç‚¹æœ¬åœ°å­˜å‚¨ä¸ºåŸºç¡€ï¼ŒæŒ‰éœ€æ¥å…¥å¯¹è±¡å­˜å‚¨ã€å…¨æ–‡ç´¢å¼•ä¸è”é‚¦åŒæ­¥ã€‚

## æ ¸å¿ƒæœ¯è¯­

- ä¼šè¯ `Conversation`ï¼šä¸€ç»„å‚ä¸è€…çš„äº¤æµä¸Šä¸‹æ–‡ï¼ŒåŒ…å«åŠ å¯†çŠ¶æ€ä¸ç­–ç•¥ã€‚
- å‚ä¸è€… `Participant`ï¼šç”¨æˆ·æˆ– AI ä»£ç†ï¼Œæ ‡è¯†é‡‡ç”¨ DID/å…¬é’¥æŒ‡çº¹ã€‚
- æ¶ˆæ¯ `Message`ï¼šä¸€æ¬¡å‘é€äº‹ä»¶ï¼Œæºå¸¦ä¸»ä½“ã€é™„ä»¶ã€å…³ç³»ä¸æ”¶æ•›ä¿¡æ¯ã€‚
- é™„ä»¶ `Attachment`ï¼šäºŒè¿›åˆ¶å¤§å¯¹è±¡ï¼Œé‡‡ç”¨å†…å®¹å¯»å€å­˜å‚¨ï¼ˆCIDï¼‰ã€‚
- ååº” `Reaction`ï¼šå¯¹æ¶ˆæ¯çš„è½»é‡åé¦ˆï¼ˆemojiã€ç‚¹èµï¼‰ã€‚
- å›æ‰§ `DeliveryReceipt`ï¼šé€è¾¾/å·²è¯»çŠ¶æ€ï¼ŒæŒ‰å‚ä¸è€…ç‹¬ç«‹è®°å½•ã€‚
- çº¿ç¨‹ `Thread`ï¼šåŸºäºå›å¤å…³ç³»å½¢æˆçš„å­è¯é¢˜ï¼Œä¿æŒå› æœé¡ºåºã€‚

## æ¶ˆæ¯ç±»å‹

- æ–‡æœ¬ï¼šçº¯æ–‡æœ¬ã€Markdownã€å¯Œæ–‡æœ¬ç‰‡æ®µã€‚
- å›¾ç‰‡ï¼šé™æ€å›¾ã€åŠ¨å›¾ï¼ˆGIF/WebPï¼‰ã€è´´çº¸/è¡¨æƒ…ã€‚
- éŸ³é¢‘ï¼šè¯­éŸ³æ¶ˆæ¯ã€é•¿éŸ³é¢‘ã€‚
- è§†é¢‘ï¼šçŸ­è§†é¢‘ã€é•¿è§†é¢‘ã€å±å¹•å½•åˆ¶ã€‚
- æ–‡ä»¶ï¼šä»»æ„æ–‡ä»¶ï¼ˆPDFã€ä»£ç åŒ…ç­‰ï¼‰ã€‚
- ä½ç½®ï¼šç»çº¬åº¦ã€POIã€æ˜¾ç¤ºåŠå¾„ã€‚
- è”ç³»æ–¹å¼ï¼šåç‰‡ã€é‚®ç®±/ç”µè¯ã€ç¤¾äº¤è´¦å·ã€‚
- é“¾æ¥å¡ç‰‡ï¼šURL åŠè§£æå‡ºçš„æ ‡é¢˜ã€æ‘˜è¦ã€ç¼©ç•¥å›¾ã€‚
- æŠ•ç¥¨ï¼šé€‰é¡¹ã€æˆªæ­¢æ—¶é—´ã€åŒ¿åè®¾ç½®ã€‚
- ç³»ç»Ÿäº‹ä»¶ï¼šåŠ å…¥/é€€å‡ºã€æƒé™å˜æ›´ã€ä¼šè¯è®¾ç½®æ›´æ–°ã€‚
- å›å¤/å¼•ç”¨ï¼šæŒ‡å‘çˆ¶æ¶ˆæ¯ã€å¼•ç”¨ç‰‡æ®µã€‚
- ç¼–è¾‘ä¸åˆ é™¤ï¼šæ¶ˆæ¯å†…å®¹æ›´æ­£ã€æ’¤å›ï¼Œä½¿ç”¨å¯å®¡è®¡çš„å˜æ›´æ¡ç›®ã€‚
- ååº”ï¼šemoji/ç‚¹èµï¼Œæ”¯æŒæ’¤é”€ã€‚
- ç½®é¡¶ä¸æ ‡ç­¾ï¼šPinã€è¯é¢˜æ ‡ç­¾ã€æ”¶è—ã€‚
- ä¸´æ—¶æ¶ˆæ¯ï¼šå…·å¤‡ TTLï¼Œè¿‡æœŸè‡ªåŠ¨æ¸…é™¤å¹¶è®°å½•å¢“ç¢‘ã€‚
- æ‰¹é‡æ¶ˆæ¯ï¼šæ‰¹é‡å‘é€æˆ–æ‰¹é‡æ“ä½œçš„èšåˆæ¡ç›®ã€‚
- AI ç›¸å…³ï¼š
  - AI è¾“å‡ºï¼šåŒ…å« roleã€æ¨¡å‹ä¿¡æ¯ã€å·¥å…·è°ƒç”¨ã€æµå¼åˆ†ç‰‡ã€‚
  - å·¥å…·è°ƒç”¨ï¼šç»“æ„åŒ–å‚æ•°ã€å‡½æ•°åã€æ‰§è¡Œç»“æœã€‚
  - å®¡è®¡ä¸è½¨è¿¹ï¼špromptã€ç³»ç»ŸæŒ‡ä»¤ã€token ç»Ÿè®¡ã€é£é™©æ ‡ç­¾ã€‚

## æ ‡è¯†ä¸å¯»å€

- æ¶ˆæ¯ IDï¼š`msg_ulid`ï¼ˆULIDï¼Œæ—¶é—´å¯æ’åºï¼Œå…¨å±€å”¯ä¸€ï¼‰ã€‚
- å†…å®¹ IDï¼š`msg_cid`ï¼ˆå¯¹æ¶ˆæ¯ä¸»ä½“å¯†æ–‡åšå†…å®¹å¯»å€ï¼Œä¾¿äºå»é‡ä¸éªŒè¯ï¼‰ã€‚
- ä¼šè¯ IDï¼š`conv_id`ï¼ˆå¯ä¸º ULID æˆ–åŸºäºå‚ä¸è€…æ´¾ç”Ÿçš„ç¨³å®šæ ‡è¯†ï¼‰ã€‚
- å‚ä¸è€… IDï¼š`did` æˆ–å…¬é’¥æŒ‡çº¹ã€‚
- å…³ç³»æŒ‡é’ˆï¼š`parent_id`ï¼ˆå›å¤ï¼‰ã€`thread_id`ï¼ˆçº¿ç¨‹ï¼‰ã€`attachment_cid`ï¼ˆé™„ä»¶ï¼‰ã€‚

## å­˜å‚¨æ¶æ„

- æœ¬åœ°é”®å€¼å­˜å‚¨ï¼ˆKVï¼‰ï¼šç”¨äºå…ƒæ•°æ®ã€ç´¢å¼•ã€çŠ¶æ€ï¼ˆå»ºè®® RocksDB/LevelDB ç±»ï¼‰ã€‚
- è¿½åŠ å¼æ—¥å¿—ï¼ˆAppend-only Logï¼‰ï¼šæ¯ä¼šè¯ä¸€æ¡æ—¥å¿—ï¼Œè®°å½•æ¶ˆæ¯ä¸å˜æ›´äº‹ä»¶ã€‚
- å¯¹è±¡å­˜å‚¨ï¼ˆCASï¼‰ï¼šé™„ä»¶ä¸å¤§æ¶ˆæ¯ä½“æŒ‰ CID å­˜å‚¨ï¼Œæ”¯æŒæœ¬åœ°/è¿œç«¯/å»ä¸­å¿ƒåŒ–ç½‘ç»œã€‚
- ç´¢å¼•å±‚ï¼šå€’æ’ç´¢å¼•ã€æ—¶é—´åºç´¢å¼•ã€ç±»å‹ç´¢å¼•ã€å‚ä¸è€…ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ï¼ˆå¯é€‰ï¼‰ã€‚
- åŠ å¯†å±‚ï¼šä¼šè¯çº§å¯†é’¥ã€æ¶ˆæ¯çº§å¯†é’¥ã€é™„ä»¶ç‹¬ç«‹å¯†é’¥ï¼Œç»Ÿä¸€å¯†é’¥è½®æ¢ç­–ç•¥ã€‚

## æ¶ˆæ¯å°è£…

```json
{
  "envelope": {
    "msg_ulid": "01JDN0Q5KZ6V4T1ZQ4YB7E3K7M",
    "conv_id": "01JCABCD123...",
    "sender_did": "did:key:z6Mk...",
    "ts": 1731568000123,
    "type": "text|image|audio|video|file|link|poll|system|reaction|edit|delete|ai",
    "parent_id": null,
    "thread_id": null,
    "version": 1,
    "content_cid": "bafy...",
    "enc": {
      "scheme": "x3dh+double-ratchet",
      "ephemeral_pub": "...",
      "cipher": "aes-gcm",
      "nonce": "..."
    },
    "sig": "ed25519:..."
  },
  "ciphertext": "...base64...",
  "attachments": [
    {
      "cid": "bafy...",
      "mime": "image/webp",
      "bytes": 345678,
      "enc_key": "...",
      "digest": "sha256:..."
    }
  ]
}
```

å¯†æ–‡å­—æ®µåŒ…å«å…·ä½“æ¶ˆæ¯ä¸»ä½“ï¼ŒæŒ‰ç±»å‹é‡‡ç”¨ç»Ÿä¸€ç»“æ„åŒ–æ ¼å¼ï¼›å°å‹æ–‡æœ¬å¯ç›´æ¥å†…åµŒï¼Œå¤§å¯¹è±¡ä¼˜å…ˆèµ°é™„ä»¶ã€‚

## ä¸»ä½“ç»“æ„ï¼ˆç¤ºä¾‹ï¼‰

- æ–‡æœ¬

```json
{
  "text": {
    "segments": [
      { "kind": "plain", "content": "ä½ å¥½" },
      { "kind": "mention", "ref": "did:key:z6Mk..." }
    ],
    "lang": "zh-Hans"
  }
}
```

- å›¾ç‰‡

```json
{ "image": { "cid": "bafy...", "mime": "image/webp", "width": 1280, "height": 720 } }
```

- æ–‡ä»¶

```json
{ "file": { "cid": "bafy...", "name": "åˆåŒ.pdf", "mime": "application/pdf", "bytes": 1024000 } }
```

- ä½ç½®

```json
{ "location": { "lat": 31.2304, "lng": 121.4737, "radius_m": 100 } }
```

- ååº”

```json
{ "reaction": { "to": "01JDN0Q...", "emoji": "ğŸ‘", "op": "add|remove" } }
```

- ç¼–è¾‘/åˆ é™¤

```json
{ "edit": { "to": "01JDN0Q...", "patch": [{ "op": "replace", "path": "/text/segments/0/content", "value": "æ‚¨å¥½" }], "seq": 3 } }
{ "delete": { "to": "01JDN0Q...", "reason": "sender_revoke" } }
```

- AI æ¶ˆæ¯

```json
{
  "ai": {
    "role": "assistant",
    "model": { "id": "gpt-5-high", "provider": "x", "version": "2025-11" },
    "trace_id": "tr_abc123",
    "segments": [
      { "kind": "text", "content": "è¿™æ˜¯å»ºè®®â€¦" },
      { "kind": "tool_call", "name": "search", "args": { "q": "å¤©æ°”" } },
      { "kind": "tool_result", "name": "search", "result_cid": "bafy..." }
    ],
    "usage": { "prompt_tokens": 1234, "completion_tokens": 2345, "cost": { "currency": "USD", "value": 0.12 } },
    "safety": { "flags": ["benign"], "score": 0.02 }
  }
}
```

## å»ä¸­å¿ƒåŒ–åŒæ­¥

- ä¸»é¢˜åˆ’åˆ†ï¼šä»¥ `conv_id` æˆ–ä¼šè¯æ´¾ç”Ÿé€šé“ä¸º PubSub ä¸»é¢˜ï¼Œæ¶ˆæ¯æŒ‰è¿½åŠ å¼äº‹ä»¶ä¼ æ’­ã€‚
- Gossip/æ‰©æ•£ï¼šèŠ‚ç‚¹ä¹‹é—´ä»¥å“ˆå¸Œæ‘˜è¦/å¸ƒéš†è¿‡æ»¤å™¨åå•†ç¼ºå¤±äº‹ä»¶ï¼ŒæŒ‰éœ€æ‹‰å–ã€‚
- å­˜å–æ§åˆ¶ï¼šåŸºäºä¼šè¯æˆå‘˜çš„å…¬é’¥ç™½åå•ï¼Œéæˆå‘˜æ— æ³•è§£å¯†äº¦æ— æ³•åŠ å…¥ä¸»é¢˜ã€‚
- Store-and-forwardï¼šåœ¨çº¿èŠ‚ç‚¹ä¸ºç¦»çº¿æˆå‘˜ç¼“å­˜å¯†æ–‡ï¼Œä¿ç•™å¯é…ç½® TTL ä¸é…é¢ã€‚
- DHT/å‘ç°ï¼šé€šè¿‡ DHT å‘å¸ƒä¼šè¯å…¥å£ä¸å¯ç”¨ä¸­ç»§ï¼Œå¢å¼ºå¯è¾¾æ€§ã€‚
- å»é‡ä¸ä¸€è‡´ï¼šä»¥ `msg_cid` å»é‡ï¼ŒæŒ‰å› æœä¸æ—¶é—´æ’åºï¼›å†²çªé‡‡ç”¨ CRDT/LWWã€‚

## å› æœä¸å†²çªè§£å†³

- å› æœæ ‡è®°ï¼š`ts` + å¯é€‰å‘é‡æ—¶é’Ÿï¼›çº¿ç¨‹ä¸å›å¤ä¿æŒçˆ¶å­å…³ç³»ã€‚
- ç¼–è¾‘åºåˆ—ï¼šæ¯æ¡æ¶ˆæ¯ç»´æŠ¤ `edit.seq` å•è°ƒé€’å¢ï¼Œè¾ƒå¤§è€…èƒœï¼ˆLWWï¼‰ã€‚
- åˆ é™¤å¢“ç¢‘ï¼šåˆ é™¤ç”Ÿæˆå¢“ç¢‘äº‹ä»¶ï¼Œå‚ä¸è€…æ”¶æ•›åæ¸…ç†æ˜æ–‡ä½†ä¿ç•™å¢“ç¢‘ä»¥é˜²å›æ”¾ã€‚
- åˆå¹¶ç­–ç•¥ï¼šåŒä¸€æ¶ˆæ¯çš„å¹¶å‘ååº”/æ ‡ç­¾ä»¥å»é‡é›†åˆåˆå¹¶ï¼›æ‰¹é‡æ“ä½œä»¥äº‹åŠ¡å—å¤„ç†ã€‚

## ç´¢å¼•ä¸æŸ¥è¯¢

- ä¸»ç´¢å¼•ï¼š`conv_id + ts` èŒƒå›´æ‰«æï¼Œé€‚åˆæ—¶é—´çº¿åŠ è½½ä¸æ»šåŠ¨åˆ†é¡µã€‚
- æ¬¡ç´¢å¼•ï¼šç±»å‹ã€å‚ä¸è€…ã€æ ‡ç­¾ã€çº¿ç¨‹ã€æåŠå¯¹è±¡ã€TTL çŠ¶æ€ã€‚
- å…¨æ–‡ï¼šå¯¹æ–‡æœ¬æ®µä¸å¯è§£æé™„ä»¶å»ºç«‹è¯­è¨€æ„ŸçŸ¥ç´¢å¼•ï¼ˆå¯é€‰æœåŠ¡ï¼‰ã€‚
- æŸ¥è¯¢ APIï¼š
  - `AppendMessage(envelope, ciphertext, attachments)`
  - `GetMessages(conv_id, range|after, filters)`
  - `Search(conv_id?, query, limit)`
  - `Stream(conv_id, cursor)`
  - `Ack(msg_ulid)` / `Receipts(conv_id)`

## åŠ å¯†ä¸å¯†é’¥ç®¡ç†

- ä¼šè¯å¯†é’¥åå•†ï¼šX3DH å»ºç«‹ï¼Œåç»­ Double Ratchet æ¨è¿›å‰å‘ä¿å¯†ã€‚
- é™„ä»¶å¯†é’¥ï¼šæ¯é™„ä»¶ç‹¬ç«‹éšæœºå¯†é’¥ï¼Œå¯†é’¥éšæ¶ˆæ¯ä¸»ä½“åˆ†å‘ã€‚
- è½®æ¢ç­–ç•¥ï¼šæˆå‘˜å˜æ›´æˆ–é£é™©äº‹ä»¶è§¦å‘é‡æ–°åå•†ä¸å¯†é’¥è½®æ¢ã€‚
- ç­¾åä¸éªŒè¯ï¼šå‘é€æ–¹å¯¹ envelope ç­¾åï¼›æ¥æ”¶æ–¹éªŒè¯å¹¶è®°å½•æŒ‡çº¹ã€‚
- å…ƒæ•°æ®æœ€å°åŒ–ï¼šæ˜æ–‡ä»…ä¿ç•™å¿…è¦è·¯ç”±ä¿¡æ¯ï¼ˆç±»å‹ã€æ—¶é—´ã€ä¼šè¯ IDï¼‰ï¼›å…¶ä½™ç½®äºå¯†æ–‡ã€‚

## è§„æ¨¡åŒ–åˆ†å±‚

- å°å‹ï¼ˆå•èŠ‚ç‚¹ï¼‰
  - æœ¬åœ° KV+CAS å³å¯ï¼›å¯é€‰è½»é‡å…¨æ–‡ç´¢å¼•ï¼ˆå¦‚ SQLite FTSï¼‰ã€‚
  - ä»…å‚ä¸è€…é—´ç›´è¿æˆ–å°‘é‡ä¸­ç»§ï¼›å¯¹è±¡å­˜å‚¨ä¸ºæœ¬åœ°ç£ç›˜ã€‚

- ä¸­å‹ï¼ˆè½»é‡æœåŠ¡ï¼‰
  - å¼•å…¥ä¸“ç”¨ç´¢å¼•æœåŠ¡ä¸å¯¹è±¡å­˜å‚¨ç½‘å…³ï¼›ä¸»é¢˜è·¯ç”±ä¸é™æµã€‚
  - éƒ¨ç½²å¤šä¸ªä¸­ç»§èŠ‚ç‚¹å®ç°é«˜å¯ç”¨ï¼›æ”¶æ•›ä¸å›æ‰§èšåˆæœåŠ¡ã€‚

- å¤§å‹ï¼ˆè”é‚¦/å¤šåŸŸï¼‰
  - Federation ç½‘å…³ï¼Œè·¨åŸŸèº«ä»½ä¸ä¿¡ä»»ç­–ç•¥ï¼›
  - åˆ†åŒºç´¢å¼•ã€å‹ç¼©å¿«ç…§ä¸åˆ†å±‚å­˜æ¡£ï¼›åˆè§„ä¸å®¡è®¡å‡ºå£ï¼ˆå¯†æ–‡æ“ä½œï¼‰ã€‚

## ç”Ÿå‘½å‘¨æœŸä¸åˆè§„

- ä¿ç•™ç­–ç•¥ï¼šé»˜è®¤æ°¸ä¹…ï¼›å¯¹ä¸´æ—¶æ¶ˆæ¯æŒ‰ TTL æ‰§è¡Œå¢“ç¢‘åŒ–ä¸å®‰å…¨æ“¦é™¤ã€‚
- å¯¼å‡ºä¸è¿ç§»ï¼šæŒ‰ä¼šè¯ç”ŸæˆåŠ å¯†å¿«ç…§ï¼ˆæ—¥å¿—ç‰‡æ®µ + CAS å¼•ç”¨ï¼‰ï¼Œæ–°èŠ‚ç‚¹å¯éªŒè¯é‡å»ºã€‚
- å®¡è®¡ä¸å¯è§‚å¯Ÿæ€§ï¼šç«¯ä¾§ç”Ÿæˆæœ€å°å®¡è®¡äº‹ä»¶ï¼ˆä¸å¯è§æ˜æ–‡ï¼‰ï¼Œè®°å½•æŒ‡çº¹ã€æ ¡éªŒå’Œä¸ä½¿ç”¨é‡ã€‚

## æ€§èƒ½ä¸æˆæœ¬

- è¯»å†™åˆå¹¶ï¼šæ‰¹é‡è½ç›˜ä¸å†™å…¥ç¼“å†²ï¼Œå‡å°‘éšæœº IOã€‚
- å‹ç¼©ï¼šå¯†æ–‡å—ä¸é™„ä»¶é‡‡ç”¨æµå‹ç¼©ï¼ˆé»˜è®¤ç¦ç”¨ä»¥å‡å°‘ CPUï¼‰ã€‚
- ç´¢å¼•å¢é‡ï¼šè¿½åŠ å¼æ„å»ºä¸åå°åˆå¹¶ï¼Œé¿å…é˜»å¡å‰å°å†™å…¥ã€‚
- é™„ä»¶åˆ†å—ï¼šå¤§å¯¹è±¡åˆ†å—å­˜å‚¨ä¸æ–­ç‚¹ç»­ä¼ ï¼Œå—çº§å»é‡ã€‚

## æ¥å£å¯¹é½ä¸€è§ˆï¼ˆè¡¨æ ¼ï¼‰

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½æè¿° | è®¤è¯è¦æ±‚ | ä½œç”¨åŸŸ/ä¸»ä½“ | å¤‡æ³¨ |
| --- | --- | --- | --- | --- | --- |
| /conv | POST | åˆ›å»ºä¼šè¯ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | conversation | æ”¯æŒ type=group ç­‰ |
| /conv/{id} | GET | è¯»å–ä¼šè¯è¯¦æƒ… | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | conversation | è¿”å› meta/policy/epoch |
| /conv/{id}/state | GET | è¯»å–ä¼šè¯çŠ¶æ€ï¼ˆepoch ç­‰ï¼‰ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | conversation | è½»é‡çŠ¶æ€è§†å›¾ |
| /conv/{id}/members | POST | é‚€è¯·/ç§»é™¤æˆå‘˜/è§’è‰²å˜æ›´ | å¿…éœ€ï¼ˆç®¡ç†å‘˜/æ‰€æœ‰è€…ï¼‰ | conversation | æˆå‘˜äº‹ä»¶è§¦å‘å¯†é’¥è½®æ¢ |
| /conv/{id}/members | GET | åˆ—ä¸¾æˆå‘˜ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | conversation | åªè¯» |
| /conv/{id}/key-rotate | POST | ä¼šè¯å¯†é’¥è½®æ¢ | å¿…éœ€ï¼ˆç®¡ç†å‘˜/æ‰€æœ‰è€…ï¼‰ | conversation | æå‡ epoch å¹¶åˆ†å‘æ–°å¯†é’¥ |
| /conv/{id}/msg | POST | è¿½åŠ æ¶ˆæ¯ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | message | æ”¯æŒæ‰¹é‡/äº‹åŠ¡å—/AI segments |
| /conv/{id}/msg | GET | æ‹‰å–æ¶ˆæ¯ï¼ˆcursor/åˆ†é¡µï¼‰ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | message | å‚æ•° cursor/after/limit |
| /conv/{id}/stream | GET | æµå¼è®¢é˜…ï¼ˆSSE/WSï¼‰ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | message | å¿ƒè·³ä¸é‡è¿æ¸¸æ ‡ |
| /conv/{id}/receipt | POST | ä¸ŠæŠ¥å›æ‰§ï¼ˆdelivered/readï¼‰ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | receipt | å•æ¡æˆ–æ‰¹é‡ |
| /conv/{id}/receipts | GET | æŸ¥è¯¢å›æ‰§ï¼ˆafter/aggregateï¼‰ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | receipt | èšåˆè§†å›¾å¯é€‰ |
| /conv/{id}/attach | POST | ä¸Šä¼ é™„ä»¶ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | attachment | è¿”å› CIDï¼Œæ”¯æŒåˆ†å— |
| /attach/{cid} | GET | ä¸‹è½½é™„ä»¶ï¼ˆå¯†æ–‡ï¼‰ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | attachment | ä¾æ®æƒé™ä¸æˆå‘˜æ ¡éªŒ |
| /conv/{id}/search | GET | å…¨æ–‡/ç´¢å¼•æŸ¥è¯¢ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | index | å¯é€‰å¤–éƒ¨ FTS |
| /conv/{id}/snapshot | GET | å¯¼å‡ºä¼šè¯å¿«ç…§ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | snapshot | åŠ å¯†å¿«ç…§ï¼ˆæ—¥å¿—+CASï¼‰ |
| /conv/{id}/snapshot | POST | å¯¼å…¥ä¼šè¯å¿«ç…§ | å¿…éœ€ï¼ˆæˆå‘˜èº«ä»½ï¼‰ | snapshot | éªŒè¯å¹¶é‡å»º |

## ç«¯ä¾§ä¸æœåŠ¡ä¾§åˆ†å·¥

- ç«¯ä¾§ï¼šåŠ å¯†ã€ç­¾åã€å› æœ/åˆå¹¶ã€å±€éƒ¨ç´¢å¼•ã€ç¦»çº¿ç¼“å­˜ã€é™„ä»¶åˆ†å—ã€‚
- æœåŠ¡ä¾§ï¼šä¸»é¢˜è·¯ç”±ã€å¯¹è±¡å­˜å‚¨ã€ç´¢å¼•èšåˆã€è”é‚¦äº’è”ã€é…é¢ä¸é™æµã€‚

## é£é™©ä¸å¾…å®šäº‹é¡¹

- èº«ä»½ä½“ç³»ï¼šDID æ–¹æ¡ˆä¸è·¨åŸŸä¿¡ä»»ç­–ç•¥çš„å…·ä½“é€‰æ‹©éœ€è¿›ä¸€æ­¥è¯„ä¼°ã€‚
- CRDT ç»†åŒ–ï¼šçº¿ç¨‹ä¸ç¼–è¾‘çš„ CRDT å®ç°ç»†èŠ‚ä¸è¾¹ç•Œæ¡ä»¶éœ€åŸå‹éªŒè¯ã€‚
- åæ»¥ç”¨ï¼šè·¨åŸŸé˜²åƒåœ¾æœºåˆ¶ä¸ä¿¡èª‰ç³»ç»Ÿï¼Œéœ€è¦ä¸äº§å“ç­–ç•¥ååŒã€‚

â€”â€”

æœ¬ç¨¿æ—¨åœ¨ç»™å‡ºç»Ÿä¸€çš„æ•°æ®æ¨¡å‹ä¸åˆ†å±‚æ¶æ„ï¼Œæ»¡è¶³ä¸¤ç±»ä¼šè¯çš„é€šç”¨éœ€æ±‚ï¼Œå¹¶ä¸ºåç»­å®ç°ä¸æ‰©å±•æä¾›æ¸…æ™°è¾¹ç•Œä¸æ¼”è¿›è·¯å¾„ã€‚

## æµç¨‹å›¾ä¸æ¥å£æ˜ å°„

### å‘é€/æ¥æ”¶ä¸»æµç¨‹ï¼ˆç”¨æˆ·/AI é€šç”¨ï¼‰

```mermaid
flowchart TD
  A[åˆ›å»ºä¼šè¯] --> B[å¯†é’¥åå•†/æ›´æ–°]
  B --> C[æ’°å†™æ¶ˆæ¯ä¸»ä½“]
  C --> D{æ˜¯å¦åŒ…å«é™„ä»¶}
  D -- æ˜¯ --> E[ä¸Šä¼ é™„ä»¶]
  D -- å¦ --> F[è·³è¿‡]
  E --> G[å°è£…+åŠ å¯†+ç­¾å]
  F --> G
  G --> H[è¿½åŠ æ¶ˆæ¯]
  H --> I[å‘å¸ƒ/ä¸­ç»§ä¼ æ’­]
  I --> J[æ¥æ”¶ç«¯æ‹‰å–/è®¢é˜…]
  J --> K[éªŒè¯ç­¾åä¸æˆå‘˜]
  K --> L{æ˜¯å¦ç¼ºé™„ä»¶}
  L -- æ˜¯ --> M[æŒ‰ CID è·å–é™„ä»¶]
  L -- å¦ --> N[è·³è¿‡]
  M --> O[è½ç›˜ä¸ç´¢å¼•]
  N --> O
  O --> P[ç”Ÿæˆå›æ‰§]
  P --> Q[ä¸ŠæŠ¥å›æ‰§]
  Q --> R[å‘é€ç«¯æ¥æ”¶å›æ‰§]

  classDef api fill:#E3F2FD,stroke:#1976D2,color:#0D47A1;
  class A,B,E,H,J,M,P,Q,R api;

  %% æ¥å£æ ‡æ³¨ï¼ˆä½œä¸ºå¤‡æ³¨ï¼‰
  %% A: POST /conv
  %% B: POST /conv/{id}/key-rotate æˆ–æˆå‘˜å˜æ›´è§¦å‘
  %% E: POST /conv/{id}/attach
  %% H: POST /conv/{id}/msg
  %% I: PubSub/Gossipï¼ˆèŠ‚ç‚¹é—´åè®®ï¼‰
  %% J: GET /conv/{id}/msg?cursor æˆ– GET /conv/{id}/stream
  %% M: GET /attach/{cid}
  %% P: æœ¬åœ°ç”Ÿæˆï¼ˆå†…éƒ¨ï¼‰ï¼Œå¯æŸ¥è¯¢ GET /conv/{id}/receipts
  %% Q: POST /conv/{id}/receipt
  %% R: GET /conv/{id}/receipts?after æˆ–æµå¼è®¢é˜…
```

### æ ¸å¿ƒèŠ‚ç‚¹ â†’ æ¥å£æ±‡æ€»ï¼ˆè¡¨æ ¼ï¼‰

| åœºæ™¯ | æ¥å£ | æ–¹æ³• | è¯´æ˜ |
| --- | --- | --- | --- |
| ä¼šè¯ | /conv | POST | åˆ›å»ºä¼šè¯ |
| ä¼šè¯ | /conv/{id} | GET | è¯»å–ä¼šè¯è¯¦æƒ… |
| ä¼šè¯ | /conv/{id}/state | GET | è¯»å–ä¼šè¯çŠ¶æ€ |
| æˆå‘˜ | /conv/{id}/members | POST | é‚€è¯·/ç§»é™¤/è§’è‰²å˜æ›´ |
| æˆå‘˜ | /conv/{id}/members | GET | åˆ—ä¸¾æˆå‘˜ |
| å¯†é’¥ | /conv/{id}/key-rotate | POST | ä¼šè¯å¯†é’¥è½®æ¢ï¼ˆæå‡ epochï¼‰ |
| æ¶ˆæ¯ | /conv/{id}/msg | POST | è¿½åŠ æ¶ˆæ¯ï¼ˆæ‰¹é‡/äº‹åŠ¡å—ï¼‰ |
| æ¶ˆæ¯ | /conv/{id}/msg | GET | æ‹‰å–æ¶ˆæ¯ï¼ˆcursor/åˆ†é¡µï¼‰ |
| æ¶ˆæ¯ | /conv/{id}/stream | GET | æµå¼è®¢é˜…ï¼ˆSSE/WSï¼‰ |
| å›æ‰§ | /conv/{id}/receipt | POST | ä¸ŠæŠ¥å›æ‰§ï¼ˆdelivered/readï¼‰ |
| å›æ‰§ | /conv/{id}/receipts | GET | æŸ¥è¯¢å›æ‰§ï¼ˆafter/aggregateï¼‰ |
| é™„ä»¶ | /conv/{id}/attach | POST | ä¸Šä¼ é™„ä»¶ï¼ˆè¿”å› CIDï¼‰ |
| é™„ä»¶ | /attach/{cid} | GET | ä¸‹è½½é™„ä»¶ï¼ˆå¯†æ–‡ï¼‰ |
| æ£€ç´¢ | /conv/{id}/search | GET | å…¨æ–‡/ç´¢å¼•æŸ¥è¯¢ |
| å¿«ç…§ | /conv/{id}/snapshot | GET | å¯¼å‡ºåŠ å¯†å¿«ç…§ |
| å¿«ç…§ | /conv/{id}/snapshot | POST | å¯¼å…¥åŠ å¯†å¿«ç…§ |

### å®Œæ•´æ€§æ£€æŸ¥ä¸å»ºè®®æ–°å¢ï¼ˆè¡¨æ ¼ï¼‰

| ç±»åˆ« | æ¥å£ | æ–¹æ³• | åŠŸèƒ½æè¿° | å¤‡æ³¨ |
| --- | --- | --- | --- | --- |
| ç”Ÿå‘½å‘¨æœŸ | /conv | POST | åˆ›å»ºä¼šè¯ | å·²åˆ—äºæ¥å£æ€»è¡¨ |
| ç”Ÿå‘½å‘¨æœŸ | /conv/{id} | GET | è¯»å–ä¼šè¯ | å·²åˆ—äºæ¥å£æ€»è¡¨ |
| ç”Ÿå‘½å‘¨æœŸ | /conv/{id}/state | GET | è¯»å–ä¼šè¯çŠ¶æ€ | å·²åˆ—äºæ¥å£æ€»è¡¨ |
| æˆå‘˜ | /conv/{id}/members | POST | é‚€è¯·/ç§»é™¤/è§’è‰²å˜æ›´ | å·²åˆ—äºæ¥å£æ€»è¡¨ |
| æˆå‘˜ | /conv/{id}/members | GET | åˆ—ä¸¾æˆå‘˜ | å·²åˆ—äºæ¥å£æ€»è¡¨ |
| å¯†é’¥ | /conv/{id}/key-rotate | POST | ä¼šè¯å¯†é’¥è½®æ¢ | å·²åˆ—äºæ¥å£æ€»è¡¨ |
| æµå¼ | /conv/{id}/stream | GET | æµå¼è®¢é˜…ï¼ˆSSE/WSï¼‰ | å·²åˆ—äºæ¥å£æ€»è¡¨ï¼›æˆ– POST /conv/{id}/msg?stream=1 è¿”å›åˆ†ç‰‡ |
| å›æ‰§ | /conv/{id}/receipts | GET | æŸ¥è¯¢å›æ‰§ï¼ˆafterï¼‰ | ä¾¿äºå‘é€ç«¯æ±‡æ€» |
| å¿«ç…§ | /conv/{id}/snapshot | GET/POST | å¯¼å‡º/å¯¼å…¥åŠ å¯†å¿«ç…§ | è¿ç§»/å¤‡ä»½/å¯¼å…¥ |
| å‘ç° | /.well-known/did | GET | DID å‘ç° | å¯é€‰ï¼Œç”¨äºè·¨åŸŸå‘ç° |
| å‘ç° | /.well-known/conv/{id} | GET | ä¼šè¯å…¥å£å‘ç° | å¯é€‰ï¼Œç”¨äºè·¨åŸŸå‘ç° |

### AI æ¶ˆæ¯è¡¥å……æµç¨‹ï¼ˆå·¥å…·è°ƒç”¨ï¼‰

```mermaid
flowchart TD
  A[ç”¨æˆ·å‘èµ·å¯¹è¯] --> B[ç”Ÿæˆ/åˆ·æ–°ä¼šè¯å¯†é’¥]
  B --> C[å‘é€ç”¨æˆ·æ¶ˆæ¯ï¼ˆå«ä¸Šä¸‹æ–‡å¼•ç”¨ï¼‰]
  C --> D[AI ç«¯è§£æå¹¶è®¡ç®—]
  D --> E{æ˜¯å¦è°ƒç”¨å·¥å…·}
  E -- æ˜¯ --> F[å·¥å…·è°ƒç”¨æ¶ˆæ¯ï¼ˆåµŒå…¥ segmentsï¼‰]
  E -- å¦ --> G[ç›´æ¥ç”Ÿæˆå›å¤]
  F --> H[å·¥å…·ç»“æœæ¶ˆæ¯ï¼ˆåµŒå…¥æˆ–é™„ä»¶ CIDï¼‰]
  G --> I[AI å›å¤æ¶ˆæ¯ï¼ˆå¯æµå¼åˆ†ç‰‡ï¼‰]
  H --> I
  I --> J[å‘å¸ƒ/æ‹‰å–ä¸æ ¡éªŒ]

  %% æ¥å£
  %% C: POST /conv/{id}/msg
  %% F/H/I: å‡ä¸º POST /conv/{id}/msgï¼ˆtype=aiï¼Œsegmentså«tool_call/tool_result/textï¼‰
  %% é™„ä»¶ï¼šPOST /conv/{id}/attach + GET /attach/{cid}
  %% æµå¼ï¼šGET /conv/{id}/stream æˆ– POST /conv/{id}/msg?stream=1
```
## æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€

- æœ¬åœ°çŠ¶æ€ï¼ˆä¸éšç½‘ç»œä¼ æ’­ï¼‰
  - `draft`ï¼šè‰ç¨¿æ€ï¼Œå°šæœªå°è£…æˆ–åŠ å¯†ã€‚
  - `prepared`ï¼šå·²å°è£…/åŠ å¯†/ç­¾åï¼Œå¾…å‘é€ã€‚
  - `queued`ï¼šå…¥é˜Ÿç­‰å¾…ç½‘ç»œå¯ç”¨æˆ–ç­‰å¾…é™„ä»¶å°±ç»ªã€‚
  - `attaching`ï¼šé™„ä»¶ä¸Šä¼ ä¸­ï¼ˆåˆ†å—/æ–­ç‚¹ç»­ä¼ ï¼‰ã€‚
  - `sent`ï¼šå·²è½å…¥æœ¬åœ°ä¼šè¯æ—¥å¿—ï¼ˆå¯é‡æ”¾ä»¥æ¢å¤ï¼‰ã€‚
  - `published`ï¼šå·²å‘å¸ƒåˆ°ä¸»é¢˜/ä¸­ç»§ï¼Œå…·å¤‡å¯å‘ç°æ€§ã€‚
  - `relay_ack`ï¼šæ”¶åˆ°ä¸­ç»§/å¯¹ç«¯çš„ä¼ è¾“ç¡®è®¤ï¼ˆå¯é€‰ï¼‰ã€‚
  - `failed`ï¼šæœ¬ç«¯å‘é€å¤±è´¥ï¼ˆå«åŸå› ä¸é‡è¯•ç­–ç•¥ï¼‰ã€‚
  - `expired`ï¼šTTL åˆ°æœŸï¼Œæœ¬åœ°å¢“ç¢‘åŒ–ã€‚
  - `recalled`ï¼šæ’¤å›ï¼Œæœ¬åœ°å¢“ç¢‘åŒ–ã€‚
  - `edited(seq)`ï¼šç¼–è¾‘äº‹ä»¶å·²åº”ç”¨ï¼Œåºåˆ—é€’å¢ã€‚

- æ¯æˆå‘˜å›æ‰§ï¼ˆéšç½‘ç»œä¼ æ’­ï¼‰
  - `delivered_at`ï¼šå¯†æ–‡å·²åˆ°è¾¾ä¸”é€šè¿‡ç­¾åéªŒè¯ã€‚
  - `read_at`ï¼šç”¨æˆ·å‰ç«¯å±•ç¤ºæˆ–æ˜ç¡®æ ‡è®°å·²è¯»ã€‚
  - `fail_reason`ï¼šä¸å¯è¾¾æˆ–è§£å¯†å¤±è´¥ç­‰ï¼ˆå«æ—¶é—´æˆ³ï¼‰ã€‚

```mermaid
stateDiagram-v2
  [*] --> draft
  draft --> prepared: å°è£…/åŠ å¯†/ç­¾å
  prepared --> attaching: é™„ä»¶ä¸Šä¼ 
  attaching --> prepared: ä¸Šä¼ å®Œæˆ
  attaching --> failed: ä¸Šä¼ å¤±è´¥
  prepared --> queued: ç­‰å¾…ç½‘ç»œ
  queued --> sent: è¿½åŠ æ¶ˆæ¯
  sent --> published: å‘å¸ƒåˆ°ä¸»é¢˜/ä¸­ç»§
  published --> relay_ack: ä¸­ç»§ç¡®è®¤ï¼ˆå¯é€‰ï¼‰
  published --> delivered: æ¥æ”¶ç«¯ä¸ŠæŠ¥ delivered
  delivered --> read: æ¥æ”¶ç«¯ä¸ŠæŠ¥ read
  published --> failed: ä¼ è¾“è¶…æ—¶/é‡è¯•ä¸Šé™
  read --> recalled: æ’¤å›ï¼ˆç”Ÿæˆå¢“ç¢‘ï¼‰
  read --> edited: ç¼–è¾‘ï¼ˆLWW/seqï¼‰
```

- `local_state` ç¤ºä¾‹ï¼ˆä»…å­˜æœ¬ç«¯ KVï¼Œä¸éšç½‘ç»œä¼ æ’­ï¼‰

```json
{
  "local_state": {
    "stage": "published",
    "retries": 1,
    "last_attempt_at": 1731568123456,
    "relay_acks": [{ "relay": "peer://node-a", "at": 1731568126789 }]
  },
  "receipts": {
    "did:key:zA": { "delivered_at": 1731568130001 },
    "did:key:zB": { "delivered_at": 1731568131200, "read_at": 1731568140000 },
    "did:key:zC": { "fail_reason": "decrypt_error" }
  }
}
```

## ç¾¤æ¶ˆæ¯ï¼ˆGroupï¼‰è®¾è®¡

- ä¼šè¯ç±»å‹ï¼š`group`ï¼ˆå¤šå‚ä¸è€…ï¼‰ï¼Œå«å…ƒä¿¡æ¯ï¼ˆåç§°ã€å¤´åƒã€æè¿°ã€ç­–ç•¥ï¼‰ã€‚
- è§’è‰²ä¸æƒé™ï¼š`owner`ã€`admin`ã€`member`ï¼›é‚€è¯·/ç§»é™¤ã€è§’è‰²å˜æ›´ã€ç½®é¡¶/æ ‡ç­¾ç®¡ç†ã€‚
- åŠ å¯†æ–¹æ¡ˆï¼š
  - å°ç¾¤ï¼ˆâ‰¤Nï¼‰ï¼šå¯é‡‡ç”¨ä¸¤ä¸¤åŠ å¯†ï¼ˆæ¯æ¥æ”¶è€…å•ç‹¬å°è£…ï¼‰ã€‚
  - å¤§ç¾¤ï¼šå»ºè®® Sender Keyï¼ˆç¾¤ä¼šè¯å¯†é’¥ï¼ŒæŒ‰ epoch è½®æ¢ï¼‰ï¼Œåˆå§‹å¯†é’¥é€šè¿‡ä¸¤ä¸¤åŠ å¯†åˆ†å‘ï¼›æˆå‘˜å¢åˆ è§¦å‘æ–° epochã€‚
- å› æœä¸é¡ºåºï¼šæŒ‰å‘é€è€…æœ¬åœ°å•è°ƒåºå· + æ—¶é—´æˆ³ï¼Œç¾¤å†…ä»¥å› æœåˆå¹¶ä¸ LWW å¤„ç†å¹¶å‘ã€‚
- å›æ‰§æ¨¡å‹ï¼š
  - æ¯æˆå‘˜ç‹¬ç«‹å›æ‰§ï¼ˆdelivered/read/failï¼‰ã€‚
  - éšç§å‹å¥½çš„èšåˆè¯»å–ï¼šä»…è¿”å›äººæ•°ç»Ÿè®¡æˆ–é˜ˆå€¼ä»¥ä¸Šçš„åŒ¿åè®¡æ•°ï¼ˆå¯é€‰ç­–ç•¥ï¼‰ã€‚
- Fanout ä¸ä¼ æ’­ï¼š
  - å®¢æˆ·ç«¯ fanoutï¼ˆä¸¤ä¸¤åŠ å¯†ç›´æŠ•ï¼‰æˆ–ä¸­ç»§ fanoutï¼ˆå¯†æ–‡ä¸€æ¬¡å‘å¸ƒï¼Œå¤šç«¯è®¢é˜…ï¼‰ã€‚
  - å»é‡ä»¥ `msg_cid`ï¼Œé™„ä»¶æŒ‰ CID å…±äº«ï¼Œé¿å…é‡å¤ä¸Šä¼ ã€‚

```mermaid
flowchart TD
  A[ç¾¤ä¼šè¯åˆ›å»º type=group] --> B[æˆå‘˜åˆ†å‘ä¸å¯†é’¥ epoch0]
  B --> C[æ’°å†™æ¶ˆæ¯/å¯å«é™„ä»¶]
  C --> D{å¤§ç¾¤?}
  D -- æ˜¯ --> E[Sender Key å°è£…ä¸€æ¬¡]
  D -- å¦ --> F[ä¸¤ä¸¤åŠ å¯†å¤šå°è£…]
  E --> G[å‘å¸ƒ/ä¸­ç»§ fanout]
  F --> G[å‘å¸ƒ/å¤šæŠ•]
  G --> H[æˆå‘˜è®¢é˜…/æ‹‰å–]
  H --> I[éªŒè¯ç­¾åä¸æˆå‘˜]
  I --> J[é™„ä»¶æŒ‰ CID è¡¥é½]
  J --> K[è½ç›˜ç´¢å¼•]
  K --> L[ä¸ŠæŠ¥å›æ‰§]
  L --> M[æ±‡æ€»ä¸å¯é€‰èšåˆå±•ç¤º]

  %% æ¥å£
  %% A: POST /conv?type=group
  %% B: POST /conv/{id}/members + POST /conv/{id}/key-rotate
  %% C: POST /conv/{id}/msg
  %% G: PubSub/Gossip / ä¸­ç»§
  %% H: GET /conv/{id}/msg?cursor / GET /conv/{id}/stream
  %% J: GET /attach/{cid}
  %% L: POST /conv/{id}/receipt
  %% M: GET /conv/{id}/receipts?aggregate=1
```

- ç¾¤ç­–ç•¥å­—æ®µï¼ˆç¤ºä¾‹ï¼‰

```json
{
  "conv": {
    "id": "01JGRP...",
    "type": "group",
    "meta": { "title": "é¡¹ç›®ç¾¤", "avatar_cid": "bafy..." },
    "policy": {
      "read_receipt": "per_member|aggregate|disabled",
      "fanout": "relay|client",
      "max_member": 1024
    },
    "epoch": 3
  }
}
```

- æˆå‘˜äº‹ä»¶ä¸å¯†é’¥è½®æ¢
  - `POST /conv/{id}/members` æ·»åŠ /ç§»é™¤æˆå‘˜ï¼›
  - è§¦å‘ `POST /conv/{id}/key-rotate`ï¼Œæå‡ `epoch`ï¼Œæ–°å¯†é’¥ä¸¤ä¸¤åˆ†å‘ï¼›
  - å†å²æ¶ˆæ¯ä¿æŒæ—§å¯†é’¥ï¼Œè¯»å–æŒ‰æ¶ˆæ¯æ‰€å± epoch è§£å¯†ã€‚

## ä»£ç ç»“æ„ä¸å®ç°å»ºè®®

- åˆ†å±‚ç»“æ„
  - `frame/touch/message`ï¼šæ¶ˆæ¯åŸŸæœåŠ¡ï¼ˆæ¨¡å‹ã€ä»“åº“ã€æœåŠ¡ã€è·¯ç”±ï¼‰ã€‚
  - `frame/core/store`ï¼šRDS ç®¡ç†ä¸è¡¨åˆå§‹åŒ–é’©å­ï¼›æ³¨å†Œé©±åŠ¨ä¸ `gorm.DB` è·å–ã€‚
  - `frame/core/server`ï¼šè·¯ç”±æ³¨å†Œä¸ HTTP å¤„ç†ï¼ˆHertzï¼‰ã€‚
  - `frame/core/plugin/*`ï¼šå¯¹è±¡å­˜å‚¨ã€æ³¨å†Œå‘ç°ã€ä¸­ç»§ä¸ libp2pã€IPFS/Boxo é›†æˆã€‚

- ç›®å½•å»ºè®®

```text
frame/touch/message/
  model/
    db/
      conversation.go      # ä¼šè¯ï¼ˆå« group/policy/epochï¼‰
      message.go           # æ¶ˆæ¯ä¸»ä½“ï¼ˆenvelope/å…³ç³»æŒ‡é’ˆ/ç´¢å¼•å­—æ®µï¼‰
      attachment.go        # é™„ä»¶è®°å½•ï¼ˆcid/mime/bytes/digestï¼‰
      receipt.go           # å›æ‰§ï¼ˆper-member delivered/read/failï¼‰
      reaction.go          # ååº”ï¼ˆé›†åˆå»é‡ï¼‰
      member.go            # ç¾¤æˆå‘˜ä¸è§’è‰²
      key_epoch.go         # ç¾¤ä¼šè¯å¯†é’¥ epoch
    dto/
      types.go             # ç»Ÿä¸€æ¶ˆæ¯ DTOï¼ˆtext/image/file/.../aiï¼‰
  repo/
    conversation_repo.go
    message_repo.go
    attachment_repo.go
    receipt_repo.go
    reaction_repo.go
  service/
    conversation_service.go
    message_service.go     # å‘é€/æ’¤å›/ç¼–è¾‘/ååº”/ç½®é¡¶/æ ‡ç­¾
    attachment_service.go  # åˆ†å—ä¸Šä¼ /æ–­ç‚¹ç»­ä¼ /æ ¡éªŒ
    receipt_service.go     # å›æ‰§èšåˆä¸æŸ¥è¯¢
    group_service.go       # é‚€è¯·/ç§»é™¤/è§’è‰²å˜æ›´/å¯†é’¥è½®æ¢
    crypto_service.go      # X3DH/Ratchet å°è£…ä¸ç­¾å
    sync_service.go        # PubSub/Gossip/DHT/Store-and-forward
  router/
    message_router.go      # æ˜ å°„ REST æ¥å£ï¼ˆPOST/GETï¼‰
  index/
    search_service.go      # å¯é€‰å…¨æ–‡ç´¢å¼•ï¼ˆFTS/å¤–éƒ¨æœåŠ¡ï¼‰
  cas/
    ipfs_store.go          # IPFS/Boxo é›†æˆï¼ˆCID å¯¹è±¡å­˜å‚¨ï¼‰
```

- æ¥å£ä¸æœåŠ¡å¥‘çº¦ï¼ˆæ ¸å¿ƒï¼‰

```go
type MessageStore interface {
  Append(ctx context.Context, msg *db.Message, atts []db.Attachment) error
  List(ctx context.Context, q Query) ([]*db.Message, error)
  Stream(ctx context.Context, convID string, cursor string) (<-chan *db.Message, error)
  Receipts(ctx context.Context, convID string, after int64) ([]*db.Receipt, error)
}

type AttachmentStore interface {
  Put(ctx context.Context, att *db.Attachment, r io.Reader) (cid string, err error)
  Get(ctx context.Context, cid string) (io.ReadCloser, *db.Attachment, error)
}

type ConversationService interface {
  Create(ctx context.Context, req *CreateConvReq) (*db.Conversation, error)
  Get(ctx context.Context, id string) (*db.Conversation, error)
  Members(ctx context.Context, id string) ([]*db.Member, error)
}

type GroupService interface {
  Invite(ctx context.Context, id string, members []string) error
  Remove(ctx context.Context, id string, members []string) error
  RotateKey(ctx context.Context, id string) error
}

type CryptoService interface {
  Seal(ctx context.Context, conv *db.Conversation, plain []byte, headers map[string]string) (env Envelope, ciphertext []byte, err error)
  Open(ctx context.Context, conv *db.Conversation, env Envelope, ciphertext []byte) ([]byte, error)
}

type Broker interface {
  Publish(ctx context.Context, topic string, key string, headers map[string]string, payload []byte) error
  Subscribe(ctx context.Context, topicPattern string, group string, handler func(ctx context.Context, msg Message) error, opts SubscribeOptions) (Subscription, error)
  Close() error
}

type Message struct {
  ID        string
  Topic     string
  Key       string
  Headers   map[string]string
  Payload   []byte
  Timestamp int64
}

type SubscribeOptions struct {
  ManualAck bool
  Filter    []string
}

type Subscription interface {
  Stop() error
}
```

- è·¯ç”±ä¸æœåŠ¡å™¨é›†æˆ
  - åœ¨ `frame/touch/router.go` çš„ `Routers()` ä¸­è¿½åŠ  `NewMessageRouter()`ã€‚
  - `message_router.go` ä¸­å®šä¹‰ï¼š
    - `POST /conv`ã€`GET /conv/{id}`ã€`GET /conv/{id}/state`
    - `POST /conv/{id}/members`ã€`GET /conv/{id}/members`
    - `POST /conv/{id}/key-rotate`
    - `POST /conv/{id}/msg`ã€`GET /conv/{id}/msg?cursor`ã€`GET /conv/{id}/stream`
    - `POST /conv/{id}/receipt`ã€`GET /conv/{id}/receipts?after`/`?aggregate=1`
    - `POST /conv/{id}/attach`ã€`GET /attach/{cid}`
    - `GET /conv/{id}/search?q=`ã€`GET/POST /conv/{id}/snapshot`

- è¡¨ç»“æ„ï¼ˆRDSï¼ŒGORMï¼Œå‘½åç¤ºä¾‹ï¼‰
  - `touch_conversation`ï¼š`id`ã€`type`ã€`meta(title, avatar_cid)`ã€`policy(read_receipt, fanout, max_member)`ã€`epoch`ã€`created_at`
  - `touch_conv_member`ï¼š`id`ã€`conv_id`ã€`did`ã€`role`ã€`joined_at`ã€å”¯ä¸€ç´¢å¼•(`conv_id`, `did`)
  - `touch_message`ï¼š`ulid`ã€`conv_id`ã€`sender_did`ã€`ts`ã€`type`ã€`parent_id`ã€`thread_id`ã€`content_cid`ã€`deleted`ã€`ttl_at`
  - `touch_attachment`ï¼š`cid`ã€`conv_id`ã€`msg_id`ã€`mime`ã€`bytes`ã€`digest`ã€`store`
  - `touch_receipt`ï¼š`id`ã€`msg_id`ã€`member_did`ã€`delivered_at`ã€`read_at`ã€`fail_reason`ã€å”¯ä¸€ç´¢å¼•(`msg_id`,`member_did`)
  - `touch_reaction`ï¼š`id`ã€`msg_id`ã€`member_did`ã€`emoji`ã€`op`ã€`ts`ã€å”¯ä¸€ç´¢å¼•(`msg_id`,`member_did`,`emoji`)
  - `touch_key_epoch`ï¼š`id`ã€`conv_id`ã€`epoch`ã€`key_meta_cid`ã€`created_at`

- è¡¨åˆå§‹åŒ–
  - é€šè¿‡ `frame/core/store.InitTableHooks` æ³¨å†Œ AutoMigrate é’©å­ï¼Œç°å·²é›†ä¸­åœ¨ `frame/touch/model/db/automigrate.go`ï¼Œéš `native store` æ’ä»¶å®Œæˆ RDS åˆå§‹åŒ–åè‡ªåŠ¨æ‰§è¡Œã€‚

- å¯¹è±¡å­˜å‚¨ï¼ˆCASï¼‰
  - é»˜è®¤æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼ŒæŒ‰ CID è·¯å¾„åˆ†å—ä¿å­˜ã€‚
  - å¯é€‰ IPFS/Boxo é›†æˆï¼š`cas/ipfs_store.go`ï¼Œè¯»å–/å†™å…¥é€šè¿‡ `cid` æ˜ å°„ã€‚

- åŒæ­¥å±‚
  - å°† `conv_id` æ˜ å°„ä¸º PubSub ä¸»é¢˜ï¼›æœ¬åœ°æ¶ˆæ¯è¿½åŠ åç» `Broker.Publish` å‘å¸ƒã€‚
  - è®¢é˜…ä¾§ç”¨ `Broker.Subscribe` æ¥æ”¶å¹¶è½ç›˜ï¼Œè§¦å‘é™„ä»¶è¡¥é½ä¸å›æ‰§ä¸ŠæŠ¥ã€‚

- ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€æœºè½åœ°
  - `message_service` ç»´æŠ¤ `local_state` ä¸é‡è¯•é˜Ÿåˆ—ï¼›
  - å¤±è´¥ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ä¸æœ€å¤§é‡è¯•ä¸Šé™ï¼›é™„ä»¶æ–­ç‚¹ç»­ä¼ ä¸æ ¡éªŒå¤±è´¥å›æ»šï¼›
  - æ’¤å›/ç¼–è¾‘ç”Ÿæˆäº‹ä»¶å¹¶åº”ç”¨åˆ°ç´¢å¼•ä¸æœç´¢å±‚ã€‚
