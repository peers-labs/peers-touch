# å¤šè¿›ç¨‹å¤šç”¨æˆ·è¿è¡Œè¯´æ˜

## âœ… åŠŸèƒ½å·²å®Œæˆ

æ”¯æŒå¯åŠ¨å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹ç™»å½•ä¸åŒçš„ç”¨æˆ·ï¼Œæ•°æ®å®Œå…¨éš”ç¦»ã€‚

### æ ¸å¿ƒç‰¹æ€§
âœ… **æŒ‰ç”¨æˆ·éš”ç¦»æ•°æ®**ï¼šæ¯ä¸ªç”¨æˆ·ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®ç›®å½•å’Œ Keychain  
âœ… **å…¨å±€ç”¨æˆ·åˆ—è¡¨**ï¼šæ‰€æœ‰è¿›ç¨‹å…±äº«å†å²ç™»å½•ç”¨æˆ·åˆ—è¡¨  
âœ… **æ ‡å‡†åŒ–å­˜å‚¨è·¯å¾„**ï¼šä½¿ç”¨ `FileStorageManager` å’Œ `StorageLocation.support`  
âœ… **è‡ªåŠ¨åˆå§‹åŒ–**ï¼šåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æœ€åç™»å½•çš„ç”¨æˆ·  
âœ… **ç™»å½•åé‡å¯**ï¼šåˆ‡æ¢ç”¨æˆ·åæç¤ºé‡å¯ä»¥åŠ è½½æ–°ç”¨æˆ·æ•°æ®  

## ä½¿ç”¨æ–¹æ³•

### åœºæ™¯ 1ï¼šé¦–æ¬¡å¯åŠ¨

```bash
cd client/desktop
flutter run
```

1. åº”ç”¨å¯åŠ¨ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
2. è¾“å…¥è´¦å·å¯†ç ï¼Œç‚¹å‡»ç™»å½•
3. ç™»å½•æˆåŠŸåï¼Œå¼¹å‡ºå¯¹è¯æ¡†æç¤º"è¯·é‡å¯åº”ç”¨"
4. ç‚¹å‡»"ç«‹å³é‡å¯"ï¼Œåº”ç”¨é€€å‡º
5. å†æ¬¡å¯åŠ¨ï¼Œè‡ªåŠ¨åŠ è½½è¯¥ç”¨æˆ·çš„æ•°æ®ï¼Œè¿›å…¥ä¸»ç•Œé¢

### åœºæ™¯ 2ï¼šåŒå¼€ï¼ˆä¸¤ä¸ªç”¨æˆ·åŒæ—¶åœ¨çº¿ï¼‰

```bash
# ç»ˆç«¯ 1 - ç”¨æˆ· Alice
cd client/desktop
flutter run
# ç™»å½• alice@example.com â†’ é‡å¯ â†’ ä½¿ç”¨ alice çš„æ•°æ®

# ç»ˆç«¯ 2 - ç”¨æˆ· Bob
cd client/desktop
flutter run
# ç™»å½• bob@example.com â†’ é‡å¯ â†’ ä½¿ç”¨ bob çš„æ•°æ®
```

ä¸¤ä¸ªè¿›ç¨‹å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ï¼

### åœºæ™¯ 3ï¼šåˆ‡æ¢ç”¨æˆ·

```bash
cd client/desktop
flutter run
# å½“å‰ç”¨æˆ·ï¼šalice@example.com
```

1. ç™»å‡ºå½“å‰ç”¨æˆ·
2. é‡æ–°ç™»å½•ä¸º bob@example.com
3. ç™»å½•æˆåŠŸåï¼Œæç¤º"è¯·é‡å¯åº”ç”¨"
4. é‡å¯åï¼Œè‡ªåŠ¨åŠ è½½ bob çš„æ•°æ®

## å­˜å‚¨ç»“æ„

```
~/Library/Application Support/peers_touch_desktop/
â”œâ”€â”€ global/
â”‚   â”œâ”€â”€ config.db           # å…¨å±€é…ç½®ï¼ˆå½“å‰ç™»å½•ç”¨æˆ·ï¼‰
â”‚   â””â”€â”€ users.db            # æ‰€æœ‰ç™»å½•è¿‡çš„ç”¨æˆ·åˆ—è¡¨
â”‚
â””â”€â”€ users/
    â”œâ”€â”€ alice@example.com/
    â”‚   â”œâ”€â”€ kv_storage.db   # alice çš„æ•°æ®åº“
    â”‚   â””â”€â”€ keychain: alice@example.com  # alice çš„ token
    â”‚
    â””â”€â”€ bob@example.com/
        â”œâ”€â”€ kv_storage.db   # bob çš„æ•°æ®åº“
        â””â”€â”€ keychain: bob@example.com    # bob çš„ token
```

**æ•°æ®éš”ç¦»**ï¼š
- âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„æ•°æ®ç›®å½•
- âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ Keychain è´¦æˆ·
- âœ… å…¨å±€é…ç½®å’Œç”¨æˆ·åˆ—è¡¨æ‰€æœ‰è¿›ç¨‹å…±äº«

### 2. æ ¸å¿ƒä¿®æ”¹

#### [connection.dart](file:///Users/bytedance/Documents/Projects/peers-touch/peers-touch/client/common/peers_touch_base/lib/storage/connection/connection.dart)

```dart
// è¿›ç¨‹ç‹¬ç«‹æ•°æ®åº“
LazyDatabase getConnection(String dbName) {
  final dbFolder = Directory(p.join(currentDir.path, 'data', 'process_$pid'));
  // ...
}

// å…¨å±€å…±äº«æ•°æ®åº“
LazyDatabase getGlobalConnection(String dbName) {
  final dbFolder = Directory(p.join(currentDir.path, 'data', 'global'));
  // ...
}
```

#### [secure_storage.dart](file:///Users/bytedance/Documents/Projects/peers-touch/peers-touch/client/common/peers_touch_base/lib/storage/secure_storage.dart)

```dart
SecureStorageImpl() {
  final processId = pid.toString();
  _fs = FlutterSecureStorage(
    mOptions: MacOsOptions(
      groupId: 'com.peerstouch.process$processId',
      accountName: 'process$processId',
    ),
  );
}
```

#### [global_users_storage.dart](file:///Users/bytedance/Documents/Projects/peers-touch/peers-touch/client/common/peers_touch_base/lib/storage/global_users_storage.dart)

```dart
class GlobalUsersStorage {
  // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆæ‰€æœ‰è¿›ç¨‹å…±äº«ï¼‰
  Future<void> saveUser({
    required String handle,
    String? email,
    String? avatarUrl,
    String? serverUrl,
  });

  // è·å–æ‰€æœ‰ç”¨æˆ·ï¼ˆæŒ‰æœ€åç™»å½•æ—¶é—´æ’åºï¼‰
  Future<List<GlobalUserItem>> getAllUsers();

  // è·å–æœ€åç™»å½•çš„ç”¨æˆ·
  Future<GlobalUserItem?> getLastLoginUser();
}
```

### 3. æ•°æ®æµç¨‹

#### ç™»å½•æ—¶

```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
  â†“
ç™»å½•æˆåŠŸ
  â†“
ä¿å­˜åˆ°è¿›ç¨‹ç‹¬ç«‹å­˜å‚¨ï¼ˆå½“å‰è¿›ç¨‹çš„ tokenï¼‰
  â†“
ä¿å­˜åˆ°å…¨å±€å…±äº«å­˜å‚¨ï¼ˆç”¨æˆ·ä¿¡æ¯ + æœ€åç™»å½•æ—¶é—´ï¼‰
```

#### å¯åŠ¨æ—¶

```
è¯»å–å…¨å±€å…±äº«å­˜å‚¨
  â†“
è·å–æœ€åç™»å½•çš„ç”¨æˆ·
  â†“
æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦æœ‰è¯¥ç”¨æˆ·çš„ token
  â†“
æœ‰ â†’ è‡ªåŠ¨ç™»å½•
æ—  â†’ æ˜¾ç¤ºç™»å½•é¡µé¢ï¼Œé¢„å¡«å……ç”¨æˆ·ä¿¡æ¯
```

## å¯¹æ¯” QQ/å¾®ä¿¡

| ç‰¹æ€§ | QQ/å¾®ä¿¡ | Peers-Touch |
|-----|--------|-------------|
| **å¤šå¼€æ–¹å¼** | å¯åŠ¨å‚æ•° `--profile` | è‡ªåŠ¨æŒ‰è¿›ç¨‹ ID éš”ç¦» |
| **ç”¨æˆ·åˆ—è¡¨** | å…¨å±€å…±äº« | å…¨å±€å…±äº« âœ… |
| **ç™»å½•æ€** | è¿›ç¨‹ç‹¬ç«‹ | è¿›ç¨‹ç‹¬ç«‹ âœ… |
| **æœ€åç™»å½•** | å…å¯†å¿«é€Ÿç™»å½• | å¾…å®ç° ğŸš§ |
| **åˆ‡æ¢ç”¨æˆ·** | éœ€è¦å¯†ç  | å¾…å®ç° ğŸš§ |

## å¾…å®ç°åŠŸèƒ½

- [ ] ç™»å½•é¡µé¢æ˜¾ç¤ºå†å²ç”¨æˆ·åˆ—è¡¨
- [ ] æœ€åç™»å½•ç”¨æˆ·çš„å¿«é€Ÿç™»å½•
- [ ] åˆ‡æ¢ç”¨æˆ·æ—¶çš„å¯†ç éªŒè¯
- [ ] ç”¨æˆ·å¤´åƒç¼“å­˜
- [ ] é€€å‡ºç™»å½•æ—¶æ¸…ç†è¿›ç¨‹æ•°æ®

## å¸¸è§é—®é¢˜

### Q1: è¿›ç¨‹é€€å‡ºåæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ

A: **ä¼šçš„**ã€‚è¿›ç¨‹é€€å‡ºåï¼Œè¯¥è¿›ç¨‹çš„æ•°æ®ç›®å½• `data/process_xxx/` ä¼šä¿ç•™ï¼Œä½†ä¸‹æ¬¡å¯åŠ¨ä¼šä½¿ç”¨æ–°çš„è¿›ç¨‹ IDã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç™»å½•æ€ä¿å­˜åœ¨å…¨å±€å…±äº«å­˜å‚¨
- ä¸‹æ¬¡å¯åŠ¨æ—¶ä»å…¨å±€å­˜å‚¨æ¢å¤

### Q2: å¦‚ä½•æ¸…ç†æ—§è¿›ç¨‹çš„æ•°æ®ï¼Ÿ

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹æ•°æ®
ls -la data/process_*

# åˆ é™¤ç‰¹å®šè¿›ç¨‹çš„æ•°æ®
rm -rf data/process_12345

# æ¸…ç†æ‰€æœ‰è¿›ç¨‹æ•°æ®ï¼ˆä¿ç•™å…¨å±€æ•°æ®ï¼‰
rm -rf data/process_*
```

### Q3: Keychain ä¼šä¸ä¼šè¶Šæ¥è¶Šå¤šï¼Ÿ

A: ä¼šçš„ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šåœ¨ Keychain ä¸­åˆ›å»ºä¸€ä¸ªè´¦æˆ·ã€‚

**æŸ¥çœ‹ Keychain æ•°æ®**ï¼š
```bash
security find-generic-password -s com.peerstouch
```

**æ¸…ç† Keychain**ï¼š
```bash
# åˆ é™¤ç‰¹å®šè¿›ç¨‹çš„ Keychain
security delete-generic-password -a process12345 -s com.peerstouch.process12345

# åˆ é™¤æ‰€æœ‰ Peers-Touch çš„ Keychainï¼ˆæ…ç”¨ï¼‰
security delete-generic-password -s com.peerstouch
```

### Q4: ç”Ÿäº§ç¯å¢ƒä¼šæœ‰è¿™ä¸ªé—®é¢˜å—ï¼Ÿ

A: **ä¸ä¼š**ã€‚ç”Ÿäº§ç¯å¢ƒä¸‹ï¼š
- ç”¨æˆ·é€šå¸¸åªå¯åŠ¨ä¸€ä¸ªå®ä¾‹
- å³ä½¿å¯åŠ¨å¤šä¸ªï¼Œä¹Ÿæ˜¯ä¸ºäº†å¤šè´¦å·ç™»å½•ï¼ˆç¬¦åˆè®¾è®¡ï¼‰
- æ—§è¿›ç¨‹çš„æ•°æ®ä¼šè‡ªåŠ¨è¿‡æœŸï¼ˆtoken æœ‰æ•ˆæœŸï¼‰

### Q5: ä¸ºä»€ä¹ˆä¸ç”¨ PROFILE ç¯å¢ƒå˜é‡ï¼Ÿ

A: PROFILE éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼Œä¸ç¬¦åˆ "ä»»æ„å¤šè¿›ç¨‹" çš„éœ€æ±‚ã€‚è¿›ç¨‹ ID æ˜¯è‡ªåŠ¨çš„ï¼Œæ›´ç®€å•ã€‚

## æ€§èƒ½å½±å“

- **ç£ç›˜å ç”¨**ï¼šæ¯ä¸ªè¿›ç¨‹çº¦ 1-5MBï¼ˆä¸»è¦æ˜¯ SQLite æ•°æ®åº“ï¼‰
- **Keychain å ç”¨**ï¼šæ¯ä¸ªè¿›ç¨‹çº¦ 1KBï¼ˆåªå­˜å‚¨ tokenï¼‰
- **å¯åŠ¨é€Ÿåº¦**ï¼šæ— å½±å“ï¼ˆè¿›ç¨‹ ID è·å–æ˜¯ O(1)ï¼‰

## æœªæ¥ä¼˜åŒ–

- [ ] è‡ªåŠ¨æ¸…ç†è¶…è¿‡ 7 å¤©æœªä½¿ç”¨çš„è¿›ç¨‹æ•°æ®
- [ ] è‡ªåŠ¨æ¸…ç†æ— æ•ˆçš„ Keychain æ¡ç›®
- [ ] æ”¯æŒæ‰‹åŠ¨ç®¡ç†è¿›ç¨‹æ•°æ®ï¼ˆè®¾ç½®é¡µé¢ï¼‰
- [ ] æ”¯æŒå¯¼å‡º/å¯¼å…¥ç”¨æˆ·æ•°æ®

---

**å½“å‰çŠ¶æ€**ï¼šæ ¸å¿ƒéš”ç¦»æœºåˆ¶å·²å®Œæˆ âœ…  
**ä¸‹ä¸€æ­¥**ï¼šå®ç°ç™»å½•é¡µé¢çš„ç”¨æˆ·é€‰æ‹©å’Œå¿«é€Ÿç™»å½•åŠŸèƒ½ ğŸš§
